org: kostya717
app: learning
service: learning

provider:
  name: aws
  runtime: nodejs20.x
  environment:
    TOKEN: 11111
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - dynamodb:Scan
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:Query
        - events:PutEvents          
        - events:DescribeEventBus   
        - events:ListEventBuses      
        - events:ListRules       
        - events:DescribeRule          
        - events:ListTargetsByRule  
      Resource: "*"

functions:
  description:
    handler: handler.description
    events:
      - http:
          path: /
          method: get
  get_posts:
    handler: handler.get_posts
    events:
      - http:
          path: /posts
          method: get
  get_unique_post:
    handler: handler.get_unique_post
    events:
      - http:
          path: /post/{category}/{title}
          method: get
  add_post:
    handler: handler.add_post
    events:
      - http:
          path: /add_post
          method: post
  edit_posts:
    handler: handler.edit_posts
    events:
      - http:
          path: /edit_posts/{category}/{title}
          method: put
  delete_post:
    handler: handler.delete_post
    events:
      - http:
          path: /delete_post/{category}/{title}
          method: delete
          authorizer: user_authorizer
  user_authorizer:
    handler: handler.user_authorizer
  new_post_event_listener:
    handler: handler.new_post_event_listener
    events:
      - eventBridge:
          pattern: 
            source:
                - "com.mycompany.category.new_post" 
            detail-type:
                - "post_created"
  get_posts_by_category:
    handler: handler.get_posts_by_category
    events:
      - http:
          path: /posts/{category}
          method: get
  get_info_by_categories:
    handler: handler.get_info_by_categories
    events:
      - http:
          path: /category_info
          method: get
  delete_post_event_listener:
    handler: handler.delete_post_event_listener
    events:
      - eventBridge:
          pattern: 
            source:
                - "com.mycompany.category.new_post" 
            detail-type:
                - "post_deleted"


resources:
  Resources:
    PostsWithCategories:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: posts_with_categories
        AttributeDefinitions:
          - AttributeName: category
            AttributeType: S
          - AttributeName: title
            AttributeType: S
        KeySchema:
          - AttributeName: category
            KeyType: HASH
          - AttributeName: title
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
    CategoriesCounter:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: category_counter
        AttributeDefinitions:
          - AttributeName: category
            AttributeType: S
        KeySchema:
          - AttributeName: category
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

